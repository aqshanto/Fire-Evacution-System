<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Smart Fire Evacuation System</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <style>
      @import url("https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700&display=swap");

      :root {
        --sidebar-bg: #0f172a;
        --sidebar-card: #1e293b;
        --text-sidebar-main: #f8fafc;
        --text-sidebar-sub: #94a3b8;

        --body-bg: #f1f5f9;
        --map-bg: #ffffff;

        --safe: #10b981;
        --danger: #ef4444;
        --warn: #f59e0b;

        --node-room: #3b82f6;
        --node-stair: #10b981;
        --node-door: #f59e0b;

        --shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
      }

      * {
        box-sizing: border-box;
      }

      body {
        background-color: var(--body-bg);
        font-family: "Manrope", sans-serif;
        margin: 0;
        display: flex;
        height: 100vh;
        overflow: hidden;
      }

      .sidebar {
        width: 380px;
        background-color: var(--sidebar-bg);
        color: var(--text-sidebar-main);
        padding: 30px;
        display: flex;
        flex-direction: column;
        z-index: 100;
        overflow-y: auto;
        box-shadow: 5px 0 25px rgba(0, 0, 0, 0.2);
      }

      .sidebar::-webkit-scrollbar {
        width: 6px;
      }
      .sidebar::-webkit-scrollbar-track {
        background: transparent;
      }
      .sidebar::-webkit-scrollbar-thumb {
        background-color: #334155;
        border-radius: 10px;
      }

      .header {
        margin-bottom: 30px;
        border-bottom: 1px solid #334155;
        padding-bottom: 20px;
      }
      h2 {
        margin: 0;
        font-size: 22px;
        font-weight: 700;
        display: flex;
        align-items: center;
        gap: 12px;
        color: var(--text-sidebar-main);
      }
      h2 i {
        color: var(--danger);
      }

      .subtitle {
        font-size: 13px;
        color: var(--text-sidebar-sub);
        margin-top: 5px;
        font-weight: 500;
      }

      .connection-badge {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        margin-top: 15px;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 11px;
        font-weight: 600;
        color: var(--text-sidebar-sub);
        transition: all 0.3s ease;
      }

      .dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: #475569;
      }

      .dot.online {
        background: var(--safe);
        box-shadow: 0 0 8px var(--safe);
      }

      .connection-badge.active {
        border-color: rgba(16, 185, 129, 0.3);
        background: rgba(16, 185, 129, 0.1);
        color: var(--safe);
      }

      .status-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
        margin-bottom: 30px;
      }

      .status-card {
        background: var(--sidebar-card);
        border-radius: 12px;
        padding: 15px;
        text-align: center;
        border: 1px solid #334155;
      }

      .status-label {
        font-size: 11px;
        font-weight: 700;
        text-transform: uppercase;
        color: var(--text-sidebar-sub);
        display: block;
        margin-bottom: 8px;
      }

      .status-val {
        font-size: 18px;
        font-weight: 800;
      }

      .status-val.safe {
        color: var(--safe);
      }

      .status-val.danger {
        color: var(--danger);
      }

      .room-list-header {
        font-size: 12px;
        font-weight: 700;
        color: var(--text-sidebar-sub);
        text-transform: uppercase;
        letter-spacing: 1px;
        margin-bottom: 15px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .room-item {
        background: var(--sidebar-card);
        border: 1px solid #334155;
        border-radius: 10px;
        padding: 14px 16px;
        margin-bottom: 10px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: all 0.2s ease;
        cursor: pointer;
      }

      .room-item:hover {
        transform: translateX(5px);
        background: #334155;
        border-color: #475569;
      }

      .room-name {
        font-weight: 600;
        font-size: 14px;
        color: var(--text-sidebar-main);
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .room-icon {
        color: var(--text-sidebar-sub);
        font-size: 14px;
      }

      .room-status {
        font-size: 11px;
        font-weight: 700;
        padding: 4px 10px;
        border-radius: 20px;
        background: rgba(255, 255, 255, 0.05);
        color: var(--text-sidebar-sub);
      }

      .room-item.selected {
        background: rgba(16, 185, 129, 0.15) !important;
        border: 1px solid var(--safe) !important;
      }

      .room-item.selected .room-name {
        color: var(--safe);
      }

      .room-item.danger {
        background: rgba(239, 68, 68, 0.15) !important;
        border: 1px solid var(--danger) !important;
      }

      .room-item.danger .room-name {
        color: var(--danger);
      }

      .room-item.danger .room-status {
        background: rgba(239, 68, 68, 0.2);
        color: var(--danger);
      }

      .room-status.safe {
        color: var(--safe);
        background: rgba(16, 185, 129, 0.1);
      }

      .map-area {
        flex-grow: 1;
        position: relative;
        background-color: var(--body-bg);
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 40px;
      }

      .map-container {
        position: relative;
        width: 1100px;
        height: 650px;
        background-color: var(--map-bg);
        border-radius: 20px;
        box-shadow: var(--shadow);
        overflow: hidden;
        border: 4px solid white;

        background-image: url("map.jpg");
        background-size: 100% 100%;
        background-repeat: no-repeat;
      }

      svg {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 1;
      }

      line.static-path {
        stroke: #cbd5e1;
        stroke-width: 5;
        stroke-linecap: round;
      }

      line.active-path {
        stroke: var(--safe);
        stroke-width: 8;
        stroke-linecap: round;
        stroke-dasharray: 12, 12;
        opacity: 0.9;
        animation: flowPath 0.8s linear infinite;
        filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.2));
      }
      @keyframes flowPath {
        to {
          stroke-dashoffset: -24;
        }
      }

      .node {
        position: absolute;
        transform: translate(-50%, -50%);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: 10px;
        border-radius: 50%;
        z-index: 10;
        background: #475569;
        color: white;
        border: 2px solid white;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        transition: transform 0.2s;
      }
      .node:hover {
        transform: translate(-50%, -50%) scale(1.15);
        z-index: 50;
      }

      .node.room {
        border-radius: 6px;
        padding: 0 10px;
        height: 28px;
        width: auto;
        background: var(--node-room);
      }
      .node.stair {
        background: var(--node-stair);
        width: 34px;
        height: 34px;
        font-size: 13px;
      }
      .node.door {
        width: 16px;
        height: 16px;
        background: var(--node-door);
        border-radius: 4px;
      }
      .node.waypoint {
        width: 8px;
        height: 8px;
        padding: 0;
        background: #94a3b8;
        border: none;
        box-shadow: none;
      }

      .node.fire-active {
        background-color: var(--danger) !important;
        border-color: #fee2e2 !important;
        box-shadow: 0 0 0 5px rgba(239, 68, 68, 0.4);
        z-index: 20;
        animation: pulseRed 1s infinite;
      }
      @keyframes pulseRed {
        0% {
          box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);
        }
        100% {
          box-shadow: 0 0 0 15px rgba(239, 68, 68, 0);
        }
      }

      .fire-marker {
        position: absolute;
        transform: translate(-50%, -50%);
        font-size: 36px;
        z-index: 30;
        animation: bounce 0.6s infinite alternate;
        pointer-events: none;
        filter: drop-shadow(0 4px 4px rgba(0, 0, 0, 0.3));
      }
      @keyframes bounce {
        from {
          transform: translate(-50%, -55%);
        }
        to {
          transform: translate(-50%, -70%);
        }
      }

      /* mobile */
      @media screen and (max-width: 768px) {
        body {
          flex-direction: column;
          overflow: hidden;
        }
        .map-area {
          flex: 1;
          width: 100%;
          order: 1;
          overflow: auto;
          padding: 0;
        }
        .map-container {
          transform: scale(0.7);
          transform-origin: top left;
          margin: 0;
          margin-bottom: -30%;
          margin-right: -30%;
          border: none;
          box-shadow: none;
        }
        .sidebar {
          width: 100%;
          height: 45vh;
          order: 2;
          border-right: none;
          border-top: 1px solid #334155;
          padding: 20px;
          border-radius: 20px 20px 0 0;
        }
        .header {
          margin-bottom: 15px;
        }
        .subtitle {
          display: none;
        }
        #roomContainer {
          max-height: 150px;
        }
      }
    </style>
  </head>
  <body>
    <div class="sidebar">
      <div class="header">
        <h2><i class="fa-solid fa-shield-halved"></i> Safety Monitor</h2>
        <div class="subtitle">Fire Evacuation System</div>

        <div class="connection-badge" id="connBadge">
          <div id="connDot" class="dot"></div>
          <span id="connText">Connecting...</span>
        </div>
      </div>

      <div class="status-grid">
        <div class="status-card">
          <span class="status-label">System Status</span>
          <div id="sysStatus" class="status-val safe">SECURE</div>
        </div>
        <div class="status-card">
          <span class="status-label">Active Hazards</span>
          <div id="fireCount" class="status-val">0</div>
        </div>
      </div>

      <div class="room-list-header">
        <span>Door Status (10 Doors)</span>
        <i class="fa-solid fa-layer-group"></i>
      </div>

      <div id="roomContainer">
        <div class="room-item" id="room-card-41">
          <span class="room-name"
            ><i class="fa-solid fa-door-open room-icon"></i> Class 1 (D41)</span
          ><span class="room-status" id="status-41">WAITING</span>
        </div>
        <div class="room-item" id="room-card-42">
          <span class="room-name"
            ><i class="fa-solid fa-door-open room-icon"></i> Class 1 (D42)</span
          ><span class="room-status" id="status-42">WAITING</span>
        </div>
        <div class="room-item" id="room-card-43">
          <span class="room-name"
            ><i class="fa-solid fa-door-open room-icon"></i> Class 2 (D43)</span
          ><span class="room-status" id="status-43">WAITING</span>
        </div>
        <div class="room-item" id="room-card-44">
          <span class="room-name"
            ><i class="fa-solid fa-door-open room-icon"></i> Class 2 (D44)</span
          ><span class="room-status" id="status-44">WAITING</span>
        </div>
        <div class="room-item" id="room-card-45">
          <span class="room-name"
            ><i class="fa-solid fa-door-open room-icon"></i> Class 3 (D45)</span
          ><span class="room-status" id="status-45">WAITING</span>
        </div>
        <div class="room-item" id="room-card-46">
          <span class="room-name"
            ><i class="fa-solid fa-door-open room-icon"></i> Class 3 (D46)</span
          ><span class="room-status" id="status-46">WAITING</span>
        </div>
        <div class="room-item" id="room-card-47">
          <span class="room-name"
            ><i class="fa-solid fa-door-open room-icon"></i> Class 4 (D47)</span
          ><span class="room-status" id="status-47">WAITING</span>
        </div>
        <div class="room-item" id="room-card-48">
          <span class="room-name"
            ><i class="fa-solid fa-door-open room-icon"></i> Class 4 (D48)</span
          ><span class="room-status" id="status-48">WAITING</span>
        </div>
        <div class="room-item" id="room-card-49">
          <span class="room-name"
            ><i class="fa-solid fa-door-open room-icon"></i> Class 5 (D49)</span
          ><span class="room-status" id="status-49">WAITING</span>
        </div>
        <div class="room-item" id="room-card-50">
          <span class="room-name"
            ><i class="fa-solid fa-door-open room-icon"></i> Class 5 (D50)</span
          ><span class="room-status" id="status-50">WAITING</span>
        </div>
      </div>
    </div>

    <div class="map-area">
      <div class="map-container" id="mapContainer">
        <svg id="linesLayer"></svg>
        <div id="fireMarkersLayer"></div>

        <div class="node room" id="1" style="left: 20.2%; top: 33.3%">
          Class 1
        </div>
        <div class="node room" id="2" style="left: 36.7%; top: 63.2%">
          Class 2
        </div>
        <div class="node room" id="3" style="left: 50.6%; top: 56.4%">
          Class 3
        </div>
        <div class="node room" id="4" style="left: 69.5%; top: 56.7%">
          Class 4
        </div>
        <div class="node room" id="5" style="left: 88%; top: 55%">Class 5</div>

        <div class="node stair" id="51" style="left: 17.9%; top: 54.3%">S1</div>
        <div class="node stair" id="52" style="left: 28.6%; top: 75.9%">S2</div>
        <div class="node stair" id="53" style="left: 56%; top: 69.6%">S3</div>
        <div class="node stair" id="54" style="left: 73.6%; top: 41%">S4</div>

        <div class="node door" id="41" style="left: 20.3%; top: 20.4%"></div>
        <div class="node door" id="42" style="left: 20.4%; top: 45.5%"></div>
        <div class="node door" id="43" style="left: 31.3%; top: 59.4%"></div>
        <div class="node door" id="44" style="left: 41.4%; top: 66.2%"></div>
        <div class="node door" id="45" style="left: 44.1%; top: 52.3%"></div>
        <div class="node door" id="46" style="left: 56.7%; top: 54.5%"></div>
        <div class="node door" id="47" style="left: 66.5%; top: 56.9%"></div>
        <div class="node door" id="48" style="left: 75.8%; top: 51.6%"></div>
        <div class="node door" id="49" style="left: 86.6%; top: 47.4%"></div>
        <div class="node door" id="50" style="left: 85%; top: 60.7%"></div>

        <div class="node waypoint" id="101" style="left: 22.2%; top: 18%"></div>
        <div
          class="node waypoint"
          id="102"
          style="left: 32.9%; top: 39.9%"
        ></div>
        <div class="node waypoint" id="103" style="left: 22%; top: 51%"></div>
        <div
          class="node waypoint"
          id="104"
          style="left: 25.8%; top: 59.2%"
        ></div>
        <div
          class="node waypoint"
          id="105"
          style="left: 29.2%; top: 55.3%"
        ></div>
        <div
          class="node waypoint"
          id="106"
          style="left: 36.9%; top: 47.4%"
        ></div>
        <div
          class="node waypoint"
          id="107"
          style="left: 44.3%; top: 62.8%"
        ></div>
        <div
          class="node waypoint"
          id="108"
          style="left: 48.8%; top: 66.5%"
        ></div>
        <div
          class="node waypoint"
          id="109"
          style="left: 55.9%; top: 66.5%"
        ></div>
        <div
          class="node waypoint"
          id="110"
          style="left: 60.1%; top: 66.5%"
        ></div>
        <div
          class="node waypoint"
          id="111"
          style="left: 32.1%; top: 72.3%"
        ></div>
        <div
          class="node waypoint"
          id="112"
          style="left: 60.1%; top: 54.7%"
        ></div>
        <div
          class="node waypoint"
          id="113"
          style="left: 60.1%; top: 47.4%"
        ></div>
        <div
          class="node waypoint"
          id="114"
          style="left: 62.8%; top: 47.4%"
        ></div>
        <div
          class="node waypoint"
          id="115"
          style="left: 62.8%; top: 56.9%"
        ></div>
        <div
          class="node waypoint"
          id="116"
          style="left: 62.8%; top: 66.5%"
        ></div>
        <div
          class="node waypoint"
          id="117"
          style="left: 75.8%; top: 47.4%"
        ></div>
        <div
          class="node waypoint"
          id="118"
          style="left: 66.5%; top: 66.5%"
        ></div>
        <div class="node waypoint" id="119" style="left: 85%; top: 66.6%"></div>
      </div>
    </div>

    <script>
      const firebaseConfig = {
        apiKey: "AIzaSyDw-2XuvXuCQtLWGkUsKcQA2X0hHJsHT70",
        databaseURL: "https://fireevacsystem-default-rtdb.firebaseio.com",
      };

      firebase.initializeApp(firebaseConfig);
      const db = firebase.database();

      let currentData = null;
      let selectedDoorId = null;

      const graphConnections = [
        [41, 42],
        [41, 101],
        [42, 103],
        [43, 44],
        [43, 105],
        [44, 107],
        [45, 46],
        [45, 106],
        [46, 112],
        [47, 48],
        [47, 115],
        [47, 118],
        [48, 117],
        [49, 50],
        [49, 117],
        [50, 119],
        [101, 102],
        [102, 103],
        [102, 106],
        [103, 51],
        [103, 104],
        [104, 105],
        [104, 111],
        [105, 106],
        [106, 107],
        [106, 113],
        [107, 108],
        [108, 109],
        [109, 53],
        [109, 110],
        [110, 112],
        [110, 116],
        [111, 52],
        [112, 113],
        [113, 114],
        [114, 115],
        [114, 117],
        [115, 116],
        [116, 118],
        [117, 54],
        [118, 119],
      ];

      const svg = document.getElementById("linesLayer");
      const container = document.getElementById("mapContainer");
      const fireMarkersLayer = document.getElementById("fireMarkersLayer");

      function drawStaticGraph() {
        const w = container.offsetWidth;
        const h = container.offsetHeight;
        graphConnections.forEach((pair) => {
          const u = document.getElementById(pair[0]);
          const v = document.getElementById(pair[1]);
          if (u && v) {
            const x1 = (parseFloat(u.style.left) / 100) * w;
            const y1 = (parseFloat(u.style.top) / 100) * h;
            const x2 = (parseFloat(v.style.left) / 100) * w;
            const y2 = (parseFloat(v.style.top) / 100) * h;
            const line = document.createElementNS(
              "http://www.w3.org/2000/svg",
              "line"
            );
            line.setAttribute("x1", x1);
            line.setAttribute("y1", y1);
            line.setAttribute("x2", x2);
            line.setAttribute("y2", y2);
            line.setAttribute("class", "static-path");
            svg.appendChild(line);
          }
        });
      }

      function drawActivePath(pathArray) {
        if (!pathArray || pathArray.length < 2) return;
        const w = container.offsetWidth;
        const h = container.offsetHeight;

        for (let i = 0; i < pathArray.length - 1; i++) {
          const uId = pathArray[i];
          const vId = pathArray[i + 1];
          const u = document.getElementById(uId);
          const v = document.getElementById(vId);

          if (u && v) {
            const x1 = (parseFloat(u.style.left) / 100) * w;
            const y1 = (parseFloat(u.style.top) / 100) * h;
            const x2 = (parseFloat(v.style.left) / 100) * w;
            const y2 = (parseFloat(v.style.top) / 100) * h;
            const line = document.createElementNS(
              "http://www.w3.org/2000/svg",
              "line"
            );
            line.setAttribute("x1", x1);
            line.setAttribute("y1", y1);
            line.setAttribute("x2", x2);
            line.setAttribute("y2", y2);
            line.setAttribute("class", "active-path");
            svg.appendChild(line);
          }
        }
      }

      function visualizeFire(nodeId) {
        const node = document.getElementById(nodeId);
        if (node) {
          node.classList.add("fire-active");
          const emoji = document.createElement("div");
          emoji.className = "fire-marker";
          emoji.innerHTML = "ðŸ”¥";
          emoji.style.left = node.style.left;
          emoji.style.top = node.style.top;
          fireMarkersLayer.appendChild(emoji);
        }
      }

      function resetVisualization() {
        document.querySelectorAll(".active-path").forEach((e) => e.remove());
        fireMarkersLayer.innerHTML = "";
        document
          .querySelectorAll(".node")
          .forEach((e) => e.classList.remove("fire-active"));
      }

      document.querySelectorAll(".room-item").forEach((item) => {
        item.addEventListener("click", function () {
          const idParts = this.id.split("-");
          const clickedId = parseInt(idParts[2]);
          if (selectedDoorId === clickedId) {
            selectedDoorId = null;
          } else {
            selectedDoorId = clickedId;
          }
          renderDashboard();
        });
      });

      function renderDashboard() {
        if (!currentData) return;
        resetVisualization();
        document
          .querySelectorAll(".room-item")
          .forEach((el) => el.classList.remove("selected"));

        const sysStatus = document.getElementById("sysStatus");
        const fireCount = document.getElementById("fireCount");
        let totalFires = new Set();
        let systemDangerous = false;

        Object.keys(currentData).forEach((key) => {
          const log = currentData[key];
          const doorId = log.door_id;

          if (log.fire_nodes && log.fire_nodes.trim() !== "") {
            const fires = log.fire_nodes.split(" ");
            fires.forEach((fId) => {
              if (fId) totalFires.add(fId);
            });
            systemDangerous = true;
          }

          const roomCard = document.getElementById(`room-card-${doorId}`);
          if (roomCard) {
            const statusSpan = roomCard.querySelector(".room-status");
            statusSpan.innerText = log.status;

            roomCard.classList.remove("danger");
            statusSpan.classList.remove("safe");
            statusSpan.style.color = "";

            if (log.status === "DANGEROUS" || log.status === "TRAPPED") {
              roomCard.classList.add("danger");
            } else if (log.status === "SAFE") {
              statusSpan.classList.add("safe");
            }

            if (selectedDoorId === doorId) {
              roomCard.classList.add("selected");
            }
          }

          const shouldDraw =
            selectedDoorId === null || selectedDoorId === doorId;
          if (
            shouldDraw &&
            log.status === "SAFE" &&
            log.path &&
            log.path !== "No Path"
          ) {
            const pathNodes = log.path.split("->");
            drawActivePath(pathNodes);
          }
        });

        totalFires.forEach((nodeId) => {
          visualizeFire(nodeId);
        });
        fireCount.innerText = totalFires.size;

        if (systemDangerous) {
          sysStatus.innerText = "DANGER";
          sysStatus.className = "status-val danger";
        } else {
          sysStatus.innerText = "SECURE";
          sysStatus.className = "status-val safe";
        }
      }

      const logsRef = db.ref("evacuation_logs");
      logsRef.on("value", (snapshot) => {
        currentData = snapshot.val();
        renderDashboard();
      });

      const connectedRef = db.ref(".info/connected");
      connectedRef.on("value", (snap) => {
        const badge = document.getElementById("connBadge");
        const dot = document.getElementById("connDot");
        const text = document.getElementById("connText");

        if (snap.val() === true) {
          dot.classList.add("online");
          text.innerText = "Live";
          badge.classList.add("active");
        } else {
          dot.classList.remove("online");
          text.innerText = "Offline";
          badge.classList.remove("active");
        }
      });

      setTimeout(drawStaticGraph, 100);

      container.addEventListener("click", function (e) {
        const rect = container.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;
        const leftPercent = ((x / rect.width) * 100).toFixed(1);
        const topPercent = ((y / rect.height) * 100).toFixed(1);
        const styleCode = `style="left: ${leftPercent}%; top: ${topPercent}%"`;
        console.log(styleCode);
      });
    </script>
  </body>
</html>
