<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Smart Fire Evacuation System</title>
    <!-- Font Awesome -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <style>
      @import url("https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Fira+Code&display=swap");

      :root {
        --bg-dark: #0f172a;
        --bg-panel: #1e293b;
        --text-primary: #f1f5f9;
        --text-secondary: #94a3b8;
        --accent-safe: #10b981; /* Emerald 500 */
        --accent-danger: #ef4444; /* Red 500 */
        --accent-warn: #f59e0b; /* Amber 500 */
        --accent-info: #3b82f6; /* Blue 500 */
        --border-color: #334155;
        --card-bg: rgba(255, 255, 255, 0.03);
      }

      * {
        box-sizing: border-box;
      }

      body {
        background-color: var(--bg-dark);
        color: var(--text-primary);
        font-family: "Poppins", sans-serif;
        margin: 0;
        display: flex;
        height: 100vh;
        overflow: hidden;
      }

      /* --- LEFT SIDEBAR --- */
      .sidebar {
        width: 400px;
        background-color: var(--bg-panel);
        border-right: 1px solid var(--border-color);
        padding: 25px;
        display: flex;
        flex-direction: column;
        box-shadow: 4px 0 20px rgba(0, 0, 0, 0.4);
        z-index: 100;
        overflow-y: auto;
      }

      .header {
        margin-bottom: 30px;
        border-bottom: 1px solid var(--border-color);
        padding-bottom: 15px;
      }

      h2 {
        color: var(--text-primary);
        margin: 0;
        font-size: 22px;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      h2 i {
        color: var(--accent-danger);
      }
      .subtitle {
        font-size: 12px;
        color: var(--text-secondary);
        margin-top: 5px;
      }

      /* Status Grid */
      .status-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
        margin-bottom: 25px;
      }

      .status-card {
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 15px;
        text-align: center;
        transition: transform 0.2s;
      }
      .status-card:hover {
        transform: translateY(-2px);
        border-color: var(--text-secondary);
      }

      .status-label {
        font-size: 11px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: var(--text-secondary);
        margin-bottom: 5px;
        display: block;
      }

      .status-val {
        font-size: 16px;
        font-weight: 700;
        color: var(--text-primary);
      }
      .status-val.safe {
        color: var(--accent-safe);
      }
      .status-val.danger {
        color: var(--accent-danger);
      }

      /* Room List */
      .room-list-header {
        font-size: 14px;
        font-weight: 600;
        color: var(--text-secondary);
        margin-bottom: 15px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .room-item {
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 12px 15px;
        margin-bottom: 10px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: all 0.3s ease;
      }

      .room-name {
        font-weight: 500;
        font-size: 14px;
      }
      .room-status {
        font-size: 12px;
        font-weight: 600;
        padding: 4px 8px;
        border-radius: 4px;
        background: rgba(16, 185, 129, 0.1);
        color: var(--accent-safe);
      }

      .room-item.danger {
        border-color: var(--accent-danger);
        background: rgba(239, 68, 68, 0.05);
      }
      .room-item.danger .room-status {
        background: rgba(239, 68, 68, 0.1);
        color: var(--accent-danger);
      }

      /* Connection Footer */
      .footer {
        margin-top: auto;
        padding-top: 20px;
        border-top: 1px solid var(--border-color);
        font-size: 12px;
        color: var(--text-secondary);
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: var(--text-secondary);
      }
      .dot.online {
        background: var(--accent-safe);
        box-shadow: 0 0 8px var(--accent-safe);
      }

      /* --- RIGHT MAP AREA --- */
      .map-area {
        flex-grow: 1;
        position: relative;
        background-color: #0b1120;
        background-image: radial-gradient(
          var(--border-color) 1px,
          transparent 1px
        );
        background-size: 30px 30px;
        display: flex;
        justify-content: center;
        align-items: center;
      }

      .map-container {
        position: relative;
        width: 1100px;
        height: 650px;
        background-color: white;
        border-radius: 16px;
        box-shadow: 0 0 50px rgba(0, 0, 0, 0.5);
        background-image: url("map.jpg");
        background-size: 100% 100%;
        background-repeat: no-repeat;
        overflow: hidden;
      }

      /* SVG Layer */
      svg {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 1;
      }

      /* Static Paths (Grey) */
      line.static-path {
        stroke: rgba(0, 0, 0, 0.15);
        stroke-width: 6;
        stroke-linecap: round;
        transition: all 0.5s ease;
      }

      /* Active Safe Path Style */
      line.active-path {
        stroke: var(--accent-green) !important;
        stroke-width: 10 !important;
        stroke-opacity: 0.8;
        animation: flowPath 1s linear infinite;
        filter: drop-shadow(0 0 5px rgba(34, 197, 94, 0.5));
      }

      @keyframes flowPath {
        0% {
          stroke-dasharray: 15;
          stroke-dashoffset: 30;
        }
        100% {
          stroke-dasharray: 15;
          stroke-dashoffset: 0;
        }
      }

      /* --- VISIBLE NODES --- */
      .node {
        position: absolute;
        transform: translate(-50%, -50%);
        min-width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: 10px;
        border-radius: 50%;
        cursor: pointer;
        z-index: 10;
        transition: all 0.2s ease;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        user-select: none;
        border: 2px solid rgba(255, 255, 255, 0.5);
        background: rgba(59, 130, 246, 0.8); /* Default Blue */
        color: white;
      }

      .node.room {
        border-radius: 6px;
        padding: 0 8px;
        height: 30px;
        width: auto;
        background: rgba(59, 130, 246, 0.9);
      }

      .node.stair {
        background: rgba(16, 185, 129, 0.9);
        width: 40px;
        height: 40px;
        font-size: 9px;
        text-align: center;
      }

      .node.door {
        width: 15px;
        height: 15px;
        min-width: 15px;
        background: rgba(245, 158, 11, 0.9);
        font-size: 0;
        border-radius: 4px;
        z-index: 12;
      }

      .node.waypoint {
        width: 12px;
        height: 12px;
        min-width: 12px;
        padding: 0;
        font-size: 0;
        background: rgba(255, 255, 255, 0.4);
        border: 1px solid rgba(0, 0, 0, 0.2);
      }

      .node:hover {
        transform: translate(-50%, -50%) scale(1.1);
        z-index: 11;
        box-shadow: 0 8px 15px rgba(0, 0, 0, 0.4);
      }

      .fire-marker {
        position: absolute;
        transform: translate(-50%, -50%);
        font-size: 28px;
        z-index: 15;
        animation: burn 0.8s infinite alternate;
        display: none;
      }
      .fire-marker.visible {
        display: block;
      }

      @keyframes burn {
        from {
          transform: translate(-50%, -50%) scale(1);
          filter: drop-shadow(0 0 4px orange);
        }
        to {
          transform: translate(-50%, -50%) scale(1.15);
          filter: drop-shadow(0 0 10px red);
        }
      }
    </style>
  </head>
  <body>
    <div class="sidebar">
      <div class="header">
        <h2><i class="fa-solid fa-shield-halved"></i> Safety Monitor</h2>
        <div class="subtitle">Live Fire Evacuation Dashboard</div>
      </div>

      <div class="status-grid">
        <div class="status-card">
          <span class="status-label">System Status</span>
          <div id="sysStatus" class="status-val safe">NORMAL</div>
        </div>
        <div class="status-card">
          <span class="status-label">Active Fires</span>
          <div id="fireCount" class="status-val">0</div>
        </div>
      </div>

      <div class="room-list-header">
        <span>Room Status</span>
        <i class="fa-solid fa-list-ul"></i>
      </div>

      <div id="roomContainer">
        <div class="room-item" id="room-card-1">
          <span class="room-name">Classroom 1</span>
          <span class="room-status">SAFE</span>
        </div>
        <div class="room-item" id="room-card-2">
          <span class="room-name">Classroom 2</span>
          <span class="room-status">SAFE</span>
        </div>
        <div class="room-item" id="room-card-3">
          <span class="room-name">Classroom 3</span>
          <span class="room-status">SAFE</span>
        </div>
        <div class="room-item" id="room-card-4">
          <span class="room-name">Classroom 4</span>
          <span class="room-status">SAFE</span>
        </div>
        <div class="room-item" id="room-card-5">
          <span class="room-name">Classroom 5</span>
          <span class="room-status">SAFE</span>
        </div>
      </div>

      <div class="footer">
        <div id="connDot" class="dot"></div>
        <span id="connText">Connecting to Firebase...</span>
      </div>
    </div>

    <div class="map-area">
      <div class="map-container" id="mapContainer">
        <svg id="linesLayer"></svg>

        <div id="fireIcon1" class="fire-marker">ðŸ”¥</div>
        <div id="fireIcon2" class="fire-marker">ðŸ”¥</div>
        <div id="fireIcon3" class="fire-marker">ðŸ”¥</div>

        <!-- NODES -->
        <!-- Rooms -->
        <div class="node room" id="1" style="left: 20.2%; top: 33.3%">
          Class 1
        </div>
        <div class="node room" id="2" style="left: 36.7%; top: 63.2%">
          Class 2
        </div>
        <div class="node room" id="3" style="left: 50.6%; top: 56.4%">
          Class 3
        </div>
        <div class="node room" id="4" style="left: 69.5%; top: 56.7%">
          Class 4
        </div>
        <div class="node room" id="5" style="left: 88%; top: 55%">Class 5</div>

        <!-- Stairs -->
        <div class="node stair" id="51" style="left: 17.9%; top: 54.3%">
          Stair 1
        </div>
        <div class="node stair" id="52" style="left: 28.6%; top: 75.9%">
          Stair 2
        </div>
        <div class="node stair" id="53" style="left: 56%; top: 69.6%">
          Stair 3
        </div>
        <div class="node stair" id="54" style="left: 73.6%; top: 41%">
          Stair 4
        </div>

        <!-- Doors -->
        <div class="node door" id="41" style="left: 20.3%; top: 20.4%"></div>
        <div class="node door" id="42" style="left: 20.4%; top: 45.5%"></div>
        <div class="node door" id="43" style="left: 31.3%; top: 59.4%"></div>
        <div class="node door" id="44" style="left: 41.4%; top: 66.2%"></div>
        <div class="node door" id="45" style="left: 44.1%; top: 52.3%"></div>
        <div class="node door" id="46" style="left: 56.7%; top: 54.5%"></div>
        <div class="node door" id="47" style="left: 66.5%; top: 56.9%"></div>
        <div class="node door" id="48" style="left: 75.8%; top: 51.6%"></div>
        <div class="node door" id="49" style="left: 86.6%; top: 47.4%"></div>
        <div class="node door" id="50" style="left: 85%; top: 60.7%"></div>

        <!-- Waypoints (101-118) -->
        <div class="node waypoint" id="101" style="left: 22.2%; top: 18%"></div>
        <div
          class="node waypoint"
          id="102"
          style="left: 32.9%; top: 39.9%"
        ></div>
        <div class="node waypoint" id="103" style="left: 22%; top: 51%"></div>
        <div
          class="node waypoint"
          id="104"
          style="left: 25.8%; top: 59.2%"
        ></div>
        <div
          class="node waypoint"
          id="105"
          style="left: 29.2%; top: 55.3%"
        ></div>
        <div
          class="node waypoint"
          id="106"
          style="left: 36.9%; top: 47.4%"
        ></div>
        <div
          class="node waypoint"
          id="107"
          style="left: 44.3%; top: 62.8%"
        ></div>

        <div
          class="node waypoint"
          id="108"
          style="left: 48.8%; top: 66.5%"
        ></div>
        <div
          class="node waypoint"
          id="109"
          style="left: 55.9%; top: 66.5%"
        ></div>
        <div
          class="node waypoint"
          id="110"
          style="left: 60.1%; top: 66.5%"
        ></div>
        <div
          class="node waypoint"
          id="111"
          style="left: 32.1%; top: 72.3%"
        ></div>
        <div
          class="node waypoint"
          id="112"
          style="left: 60.1%; top: 54.7%"
        ></div>
        <div
          class="node waypoint"
          id="113"
          style="left: 60.1%; top: 47.4%"
        ></div>
        <div
          class="node waypoint"
          id="114"
          style="left: 62.8%; top: 47.4%"
        ></div>
        <div
          class="node waypoint"
          id="115"
          style="left: 62.8%; top: 56.9%"
        ></div>
        <div
          class="node waypoint"
          id="116"
          style="left: 62.8%; top: 66.5%"
        ></div>
        <div
          class="node waypoint"
          id="117"
          style="left: 75.8%; top: 47.4%"
        ></div>
        <div
          class="node waypoint"
          id="118"
          style="left: 66.5%; top: 66.5%"
        ></div>
        <div class="node waypoint" id="119" style="left: 85%; top: 66.6%"></div>
      </div>
    </div>

    <script>
      // ==========================================
      // 1. FIREBASE CONFIGURATION
      // ==========================================
      const firebaseConfig = {
        apiKey: "AIzaSyDw-2XuvXuCQtLWGkUsKcQA2X0hHJsHT70",
        databaseURL: "https://fireevacsystem-default-rtdb.firebaseio.com",
      };

      firebase.initializeApp(firebaseConfig);
      const db = firebase.database();

      // ==========================================
      // 2. GRAPH DATA (Edges for Static Drawing)
      // ==========================================
      const graphConnections = [
        [41, 42],
        [41, 101],
        [42, 103],
        [43, 44],
        [43, 105],
        [44, 107],
        [45, 46],
        [45, 106],
        [46, 112],
        [47, 48],
        [47, 115],
        [47, 118],
        [48, 117],
        [49, 50],
        [49, 117],
        [50, 119],
        [101, 102],
        [102, 103],
        [102, 106],
        [103, 51],
        [103, 104],
        [104, 105],
        [104, 111],
        [105, 106],
        [106, 107],
        [106, 113],
        [107, 108],
        [108, 109],
        [109, 53],
        [109, 110],
        [110, 112],
        [110, 116],
        [111, 52],
        [112, 113],
        [113, 114],
        [114, 115],
        [114, 117],
        [115, 116],
        [116, 118],
        [117, 54],
        [118, 119],
      ];

      // ==========================================
      // 3. UI & LOGIC
      // ==========================================
      const svg = document.getElementById("linesLayer");
      const container = document.getElementById("mapContainer");
      const rooms = [1, 2, 3, 4, 5];

      // 3.1 Draw Static Graph (Grey Lines)
      function drawStaticGraph() {
        // Clear previous lines? No, we append.
        const w = container.offsetWidth;
        const h = container.offsetHeight;

        graphConnections.forEach((pair) => {
          const u = document.getElementById(pair[0]);
          const v = document.getElementById(pair[1]);

          if (u && v) {
            const x1 = (parseFloat(u.style.left) / 100) * w;
            const y1 = (parseFloat(u.style.top) / 100) * h;
            const x2 = (parseFloat(v.style.left) / 100) * w;
            const y2 = (parseFloat(v.style.top) / 100) * h;

            const line = document.createElementNS(
              "http://www.w3.org/2000/svg",
              "line"
            );
            line.setAttribute("x1", x1);
            line.setAttribute("y1", y1);
            line.setAttribute("x2", x2);
            line.setAttribute("y2", y2);
            line.setAttribute("class", "static-path");
            svg.appendChild(line);
          }
        });
      }

      // Handle Connection Status
      const connectedRef = db.ref(".info/connected");
      connectedRef.on("value", (snap) => {
        if (snap.val() === true) {
          document.getElementById("connDot").classList.add("online");
          document.getElementById("connText").innerText =
            "Connected to Realtime DB";
        } else {
          document.getElementById("connDot").classList.remove("online");
          document.getElementById("connText").innerText = "Disconnected";
        }
      });

      // LISTEN FOR DATA CHANGES
      const rootRef = db.ref("/");
      rootRef.on("value", (snapshot) => {
        const data = snapshot.val();
        if (data) {
          updateDashboard(data);
        }
      });

      function updateDashboard(data) {
        const sysStatus = document.getElementById("sysStatus");
        const fireCount = document.getElementById("fireCount");

        if (data.systemStatus === "DANGER") {
          sysStatus.innerText = "EMERGENCY";
          sysStatus.className = "status-val danger";
        } else {
          sysStatus.innerText = "NORMAL";
          sysStatus.className = "status-val safe";
        }

        // Reset active paths
        document.querySelectorAll(".active-path").forEach((e) => e.remove());

        // Fire Markers
        document
          .querySelectorAll(".fire-marker")
          .forEach((el) => el.classList.remove("visible"));

        let count = 0;
        if (data.activeFires) {
          count = data.activeFires.length;
          data.activeFires.forEach((nodeId, index) => {
            if (index < 3) {
              const node = document.getElementById(nodeId);
              const icon = document.getElementById(`fireIcon${index + 1}`);
              if (node && icon) {
                icon.style.left = node.style.left;
                icon.style.top = node.style.top;
                icon.classList.add("visible");
              }
            }
          });
        }
        fireCount.innerText = count;

        // Room Paths
        if (data.rooms) {
          rooms.forEach((roomId) => {
            const roomData = data.rooms[roomId];
            const card = document.getElementById(`room-card-${roomId}`);
            const statusSpan = card.querySelector(".room-status");

            if (roomData) {
              if (
                roomData.status === "DANGER" ||
                roomData.status === "EVACUATE"
              ) {
                card.classList.add("danger");
                statusSpan.innerText = "EVACUATE";
                if (roomData.path && Array.isArray(roomData.path)) {
                  drawActivePath(roomData.path);
                }
              } else {
                card.classList.remove("danger");
                statusSpan.innerText = "SAFE";
              }
            }
          });
        }
      }

      function drawActivePath(pathArray) {
        if (!pathArray || pathArray.length < 2) return;

        const w = container.offsetWidth;
        const h = container.offsetHeight;

        for (let i = 0; i < pathArray.length - 1; i++) {
          const uId = pathArray[i];
          const vId = pathArray[i + 1];
          const u = document.getElementById(uId);
          const v = document.getElementById(vId);

          if (u && v) {
            const x1 = (parseFloat(u.style.left) / 100) * w;
            const y1 = (parseFloat(u.style.top) / 100) * h;
            const x2 = (parseFloat(v.style.left) / 100) * w;
            const y2 = (parseFloat(v.style.top) / 100) * h;

            const line = document.createElementNS(
              "http://www.w3.org/2000/svg",
              "line"
            );
            line.setAttribute("x1", x1);
            line.setAttribute("y1", y1);
            line.setAttribute("x2", x2);
            line.setAttribute("y2", y2);
            line.setAttribute("class", "active-path");
            svg.appendChild(line);
          }
        }
      }

      // Draw static lines on load
      setTimeout(drawStaticGraph, 100);

      // --- SIMULATION LOOP (DEMO) ---
      // This forces the "green" path to appear after 2 seconds
      setTimeout(() => {
        updateDashboard({
          systemStatus: "DANGER",
          activeFires: [106],
          rooms: {
            3: {
              status: "EVACUATE",
              path: [3, 45, 103, 102, 101, 41, 1, 101, 102],
            },
            // Note: Just a dummy path to prove visualization works
          },
        });
      }, 2000);
    </script>
  </body>
</html>
